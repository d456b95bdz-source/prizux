<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PRIZUX SOC | Security Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --bg:#0d1117; --panel:#161b22; --line:#30363d; --txt:#c9d1d9; --muted:#8b949e;
      --ok:#3fb950; --warn:#d29922; --danger:#f85149; --info:#58a6ff;
    }
    body{ background:var(--bg); color:var(--txt); font-family:Inter, "Segoe UI", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; }
    .navbar{ background:var(--panel); border-bottom:1px solid var(--line); }
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:12px; }
    .small-muted{ color:var(--muted); font-size:.875rem; }
    .metric-value{ font-size:1.65rem; font-weight:700; }
    .log-box{
      background:#010409; border:1px solid var(--line);
      border-radius:10px; padding:14px; max-height:360px; overflow:auto;
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:.87rem;
    }
    .reason-badge{
      font-size:.75rem; border:1px solid var(--line);
      border-radius:999px; padding:.2rem .5rem; color:var(--muted);
      display:inline-block; margin:.15rem .15rem 0 0;
    }
    .grade-wrap{ display:flex; align-items:center; gap:.55rem; }

    /* sprite */
    .scp-icon{
      width:30px; height:30px; display:inline-block; flex:0 0 30px;
      border-radius:50%;
      background-image:url('/soc/static/icons/scp-sprite.png');
      background-repeat:no-repeat;
      background-size:736px 713px;
      box-shadow:0 0 0 1px rgba(255,255,255,.06) inset;
    }
    .i-safe   { background-position:-74px  -197px; }
    .i-euclid { background-position:-196px -197px; }
    .i-keter  { background-position:-318px -197px; }
    .i-apollyon { background:none; border:1px solid var(--line); position:relative; }
    .i-apollyon::after{ content:'A'; position:absolute; left:50%; top:50%; transform:translate(-50%,-55%); font-weight:900; color:var(--danger); }

    .i-neutralized { background-position:-440px -197px; }
    .i-pending { background-position:-562px -197px; }

    .i-unknown{
      background:none; border:1px solid var(--line);
      position:relative; width:30px; height:30px; border-radius:50%;
      box-shadow:none;
    }
    .i-unknown::after{
      content:'?'; position:absolute; left:50%; top:50%;
      transform:translate(-50%,-55%);
      font-weight:800; font-size:14px; color:var(--muted);
    }

    .tab-btn{ cursor:pointer; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark sticky-top">
    <div class="container-fluid">
      <div class="navbar-brand fw-bold">
        <i class="bi bi-shield-lock-fill text-primary me-2"></i>
        PRIZUX SOC <span class="fw-light text-secondary">| Security Hub</span>
      </div>
      <div class="d-flex gap-2">
        <span class="badge text-bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-3 py-2">
          <i class="bi bi-cpu-fill me-1"></i>Shield Active
        </span>
        <span class="badge text-bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-3 py-2">
          <i class="bi bi-check-circle-fill me-1"></i>Strict
        </span>
      </div>
    </div>
  </nav>

  <main class="container-fluid mt-4">
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card p-3">
          <div class="small-muted">Open Incidents</div>
          <div id="open-incidents" class="metric-value">0</div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card p-3">
          <div class="small-muted">Latest AIS / SIS / RSI</div>
          <div class="metric-value fs-5">
            <span id="ais">-</span> / <span id="sis">-</span> / <span id="rsi">-</span>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card p-3">
          <div class="small-muted">Traffic (RPS / IPs)</div>
          <div class="metric-value fs-5">
            <span id="rps">-</span> / <span id="ipcard">-</span>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card p-3">
          <div class="small-muted">Last Updated</div>
          <div id="last-updated" class="metric-value fs-5">-</div>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-12 col-xl-7">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 text-secondary"><i class="bi bi-exclamation-triangle me-1"></i>Incidents (24h)</h6>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-secondary" onclick="loadIncidents24h()">Refresh</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="loadGrouped(24)">Group by IP+Kind</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Grade</th>
                  <th>Severity</th>
                  <th>Title</th>
                  <th>Message</th>
                  <th>Last Seen</th>
                </tr>
              </thead>
              <tbody id="incident-list"></tbody>
            </table>
          </div>
          <div class="small-muted mt-2">
            * “묶기”는 <code>incident_key = grade:ip:kind</code> 기준으로 그룹 요약을 보여줌.
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-5">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 text-secondary"><i class="bi bi-journal-text me-1"></i>Log Viewer</h6>
            <div class="d-flex gap-2">
              <select id="log-kind" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="loadLogs()">
                <option value="nginx_access">nginx access</option>
                <option value="nginx_error">nginx error</option>
                <option value="auth">auth.log (ssh)</option>
                <option value="ufw">ufw.log</option>
                <option value="fail2ban">fail2ban.log</option>
                <option value="app_access">app access</option>
                <option value="app_auth">app auth</option>
                <option value="app_model">app model</option>
              </select>
              <button class="btn btn-sm btn-outline-secondary" onclick="loadLogs()">Tail</button>
            </div>
          </div>
          <div id="log-stream" class="log-box"><span class="small-muted">-</span></div>

          <hr class="border-secondary my-3">

          <h6 class="mb-2 text-secondary"><i class="bi bi-lightning-charge me-1"></i>SOAR Quick Action</h6>
          <div class="small-muted mb-2">
            토큰이 있어야 실행됨. (Header <code>X-SOC-Token</code>)
          </div>
          <div class="input-group mb-2">
            <input id="soc-token" class="form-control bg-dark text-light border-secondary" placeholder="SOC_ADMIN_TOKEN 입력">
          </div>
          <div class="input-group mb-2">
            <input id="block-ip" class="form-control bg-dark text-light border-secondary" placeholder="차단할 IP">
            <button class="btn btn-danger" onclick="blockIp()">Block</button>
          </div>
          <div class="d-grid">
            <button class="btn btn-outline-warning" onclick="reloadNginx()">Reload Nginx</button>
          </div>
          <div id="action-result" class="small-muted mt-2"></div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-12">
        <div class="card p-3">
          <h6 class="mb-2 text-secondary"><i class="bi bi-graph-up me-1"></i>Key Metrics (Latest)</h6>
          <div class="row g-2 small">
            <div class="col-6 col-md-3">SSTI rate: <b id="ssti">-</b></div>
            <div class="col-6 col-md-3">RCE rate: <b id="rce">-</b></div>
            <div class="col-6 col-md-3">Upstream timeout rate: <b id="uto">-</b></div>
            <div class="col-6 col-md-3">5xx rate: <b id="e5">-</b></div>
          </div>
          <div class="row g-2 small mt-1">
            <div class="col-6 col-md-3">p99 latency(ms): <b id="p99">-</b></div>
            <div class="col-6 col-md-3">path uniq: <b id="punq">-</b></div>
            <div class="col-6 col-md-3">path entropy: <b id="pent">-</b></div>
            <div class="col-6 col-md-3">ip recur 24h: <b id="recur">-</b></div>
          </div>
        </div>
      </div>
    </div>
  </main>

<script>
  function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function iconClass(grade){
    const g = String(grade||'').toUpperCase();
    if (g === 'SAFE') return 'i-safe';
    if (g === 'EUCLID') return 'i-euclid';
    if (g === 'KETER') return 'i-keter';
    if (g === 'APOLLYON') return 'i-apollyon';
    if (g === 'NEUTRALIZED') return 'i-neutralized';
    if (g === 'PENDING') return 'i-pending';
    return 'i-unknown';
  }

  async function loadLatest(){
    const res = await fetch('/soc/api/metrics/latest');
    const m = await res.json();

    document.getElementById('ais').innerText = m.ais ?? '-';
    document.getElementById('sis').innerText = m.sis ?? '-';
    document.getElementById('rsi').innerText = m.rsi ?? '-';

    document.getElementById('rps').innerText = m.req_per_sec_total ?? '-';
    document.getElementById('ipcard').innerText = m.ip_cardinality_1m ?? '-';

    document.getElementById('ssti').innerText = m.ssti_token_hit_rate ?? '-';
    document.getElementById('rce').innerText = m.rce_token_hit_rate ?? '-';
    document.getElementById('uto').innerText = m.u_upstream_timeout_rate ?? '-';
    document.getElementById('e5').innerText = m.error_rate_total ?? '-';
    document.getElementById('p99').innerText = m.latency_p99_ms ?? '-';
    document.getElementById('punq').innerText = m.path_uniqueness_rate ?? '-';
    document.getElementById('pent').innerText = m.p404_path_entropy ?? '-';
    document.getElementById('recur').innerText = m.ip_recurrence_24h ?? '-';

    document.getElementById('last-updated').innerText = new Date().toLocaleTimeString('ko-KR');
  }

  async function loadOpenCount(){
    const res = await fetch('/soc/api/incidents/open?limit=1');
    const data = await res.json();
    // open 리스트 길이로 표시하면 왜곡될 수 있으니 /summary가 있으면 더 좋은데,
    // 여기선 간단히 open 200 제한에서 length 사용
    document.getElementById('open-incidents').innerText = Array.isArray(data) ? data.length : 0;
  }

  async function loadIncidents24h(){
    const res = await fetch('/soc/api/incidents/last24h');
    const data = await res.json();
    const body = document.getElementById('incident-list');

    if (!Array.isArray(data) || data.length === 0){
      body.innerHTML = `<tr><td colspan="6" class="text-center small-muted py-4">no incidents</td></tr>`;
      return;
    }

    body.innerHTML = data.slice(0, 200).map(i => `
      <tr>
        <td>${esc(i.id)}</td>
        <td>
          <div class="grade-wrap">
            <span class="scp-icon ${iconClass(i.grade)}" title="${esc(i.grade)}"></span>
            <span>${esc(i.grade)}</span>
          </div>
        </td>
        <td>${esc(i.severity_score)}</td>
        <td>${esc(i.title)}</td>
        <td>${esc(i.message ?? '')}</td>
        <td>${esc(i.last_seen)}</td>
      </tr>
    `).join('');
  }

  async function loadGrouped(hours){
    const res = await fetch(`/soc/api/incidents/grouped?hours=${encodeURIComponent(hours||24)}`);
    const data = await res.json();
    const body = document.getElementById('incident-list');

    if (!Array.isArray(data) || data.length === 0){
      body.innerHTML = `<tr><td colspan="6" class="text-center small-muted py-4">no grouped incidents</td></tr>`;
      return;
    }

    body.innerHTML = data.slice(0, 200).map(g => `
      <tr>
        <td>-</td>
        <td>
          <div class="grade-wrap">
            <span class="scp-icon ${iconClass(g.max_grade)}" title="${esc(g.max_grade)}"></span>
            <span>${esc(g.max_grade)}</span>
          </div>
        </td>
        <td>${esc(g.max_score)}</td>
        <td>${esc(g.ip)} / ${esc(g.kind)} (x${esc(g.cnt)})</td>
        <td>
          <button class="btn btn-sm btn-outline-danger" onclick="prefillBlock('${esc(g.ip)}')">Select IP</button>
        </td>
        <td>${esc(g.last_seen)}</td>
      </tr>
    `).join('');
  }

  function prefillBlock(ip){
    document.getElementById('block-ip').value = ip;
    document.getElementById('action-result').innerText = `selected: ${ip}`;
  }

  async function loadLogs(){
    const kind = document.getElementById('log-kind').value;
    const res = await fetch(`/soc/api/logs/tail?kind=${encodeURIComponent(kind)}&lines=200`);
    const data = await res.json();
    const box = document.getElementById('log-stream');
    const lines = (data.lines || []).slice(-200);
    box.innerHTML = lines.length
      ? lines.map(l => `<div>${esc(l)}</div>`).join('')
      : `<span class="small-muted">no log lines</span>`;
  }

  async function blockIp(){
    const token = document.getElementById('soc-token').value || '';
    const ip = document.getElementById('block-ip').value || '';
    const res = await fetch(`/soc/api/actions/block-ip?ip=${encodeURIComponent(ip)}`, {
      method: 'POST',
      headers: { 'X-SOC-Token': token }
    });
    const data = await res.json();
    document.getElementById('action-result').innerText = JSON.stringify(data);
  }

  async function reloadNginx(){
    const token = document.getElementById('soc-token').value || '';
    const res = await fetch(`/soc/api/actions/reload-nginx`, {
      method: 'POST',
      headers: { 'X-SOC-Token': token }
    });
    const data = await res.json();
    document.getElementById('action-result').innerText = JSON.stringify(data);
  }

  async function boot(){
    await loadLatest();
    await loadOpenCount();
    await loadIncidents24h();
    await loadLogs();

    setInterval(loadLatest, 10000);
    setInterval(loadOpenCount, 15000);
  }
  boot();
</script>
</body>
</html>
